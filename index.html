<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãµã˜ã¿é‡æ—¥å ± - Google Sheetsé€£æºç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Mequlibri, 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
        }

        .sync-status.synced {
            background: #d4edda;
            color: #155724;
        }

        .sync-status.syncing {
            background: #fff3cd;
            color: #856404;
        }

        .sync-status.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .sync-status.pending {
            background: #d1ecf1;
            color: #0c5460;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab-btn {
            background: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 10px rgba(102,126,234,0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group small {
            color: #666;
            font-size: 12px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            margin-top: 10px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
            margin-top: 10px;
        }

        .btn-success:hover {
            background: #218838;
        }

        .data-table {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        td:first-child, th:first-child {
            text-align: left;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .positive {
            color: #28a745;
            font-weight: 600;
        }

        .negative {
            color: #dc3545;
            font-weight: 600;
        }

        .actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-edit {
            background: #ffc107;
            color: #333;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .month-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .month-selector select {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 20px;
            }

            .tabs {
                justify-content: flex-start;
            }

            .tab-btn {
                padding: 10px 16px;
                font-size: 14px;
            }

            .month-selector {
                flex-direction: column;
            }

            .month-selector select,
            .month-selector button {
                width: 100%;
            }
        }

        .config-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid;
        }

        .config-status.valid {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .config-status.invalid {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(0,0,0,.1);
            border-left-color: currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ãµã˜ã¿é‡æ—¥å ± - Google Sheetsé€£æºç‰ˆ</h1>
            <p>æ—¥ã€…ã®ä½œæ¥­ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ãƒ»è‡ªå‹•åŒæœŸ</p>
            <div id="syncStatus" class="sync-status offline">
                <span class="spinner" style="display: none;"></span>
                <span id="syncStatusText">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('input')">ğŸ“ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</button>
            <button class="tab-btn" onclick="switchTab('list')">ğŸ“‹ ä¸€è¦§è¡¨ç¤º</button>
            <button class="tab-btn" onclick="switchTab('sheets')">ğŸ”— Google Sheetsè¨­å®š</button>
            <button class="tab-btn" onclick="switchTab('settings')">âš™ï¸ è¨­å®š</button>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã‚¿ãƒ– -->
        <div id="input-tab" class="tab-content active">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #667eea;">ğŸ“ æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
                
                <form id="dataForm" onsubmit="saveData(event)">
                    <div class="form-group">
                        <label>æ—¥ä»˜ *</label>
                        <input type="date" id="date" required>
                    </div>

                    <div class="form-group">
                        <label>ä½œæ¥­Unitæ•° *</label>
                        <input type="number" id="workCost" placeholder="ä¾‹: 7000" required step="1" min="0">
                    </div>

                    <div class="form-group">
                        <label>äººæ•° *</label>
                        <input type="number" id="staffCount" placeholder="ä¾‹: 20" required step="1" min="0">
                    </div>

                    <div class="form-group">
                        <label>å‹¤å‹™ç¨®åˆ¥ *</label>
                        <select id="shiftType" required>
                            <option value="night">å¤œå‹¤</option>
                            <option value="normal">é€šå¸¸å‹¤å‹™</option>
                        </select>
                    </div>

                    <div class="alert alert-info" id="calculation-preview" style="display: none;">
                        <strong>è¨ˆç®—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</strong>
                        <div id="preview-content" style="margin-top: 10px;"></div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="submitBtn">ğŸ’¾ ä¿å­˜</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelEdit()">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </form>
            </div>
        </div>

        <!-- ä¸€è¦§è¡¨ç¤ºã‚¿ãƒ– -->
        <div id="list-tab" class="tab-content">
            <div class="card">
                <div class="month-selector">
                    <select id="monthFilter" onchange="filterByMonth()">
                        <option value="">å…¨æœŸé–“</option>
                    </select>
                    <button class="btn btn-secondary" onclick="exportToExcel()" style="width: auto; padding: 10px 20px;">
                        ğŸ“¥ Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn btn-success" onclick="syncPendingData(true)" style="width: auto; padding: 10px 20px;">
                        ğŸ”„ æ‰‹å‹•åŒæœŸ
                    </button>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>ä½œæ¥­Unitæ•°</th>
                                <th>ä½œæ¥­è²»åˆè¨ˆ</th>
                                <th>ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ</th>
                                <th>äººæ•°</th>
                                <th>çµŒè²»</th>
                                <th>åæ”¯</th>
                                <th>åŒæœŸ</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Google Sheetsè¨­å®šã‚¿ãƒ– -->
        <div id="sheets-tab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #667eea;">ğŸ”— Google Sheetsé€£æºè¨­å®š</h2>
                
                <div id="configStatus" class="config-status invalid">
                    âŒ Google Sheetsé€£æºãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“
                </div>

                <div class="alert alert-info">
                    <strong>ğŸ“š è¨­å®šæ‰‹é †æ›¸ã‚’ç¢ºèªã—ã¦ãã ã•ã„</strong><br>
                    Google Cloud Consoleã§APIã‚­ãƒ¼ã‚’å–å¾—ã—ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æº–å‚™ã—ã¦ã‹ã‚‰ä»¥ä¸‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                </div>

                <div class="alert alert-warning">
                    <strong>âš ï¸ ã‚ˆãã‚ã‚‹å•é¡Œ</strong><br>
                    <ul style="margin: 10px 0 0 20px; padding: 0;">
                        <li>ã€Œæ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...ã€ã‹ã‚‰é€²ã¾ãªã„ â†’ APIã‚­ãƒ¼ã®åˆ¶é™è¨­å®šã‚’ç¢ºèª</li>
                        <li>ã€ŒAPI key not validã€â†’ APIã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒšã—ç›´ã™</li>
                        <li>ã€ŒPermission deniedã€â†’ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ã€ã«å…±æœ‰</li>
                    </ul>
                </div>

                <form id="sheetsConfigForm" onsubmit="saveSheetsConfig(event)">
                    <div class="form-group">
                        <label>èªè¨¼æ–¹å¼</label>
                        <select id="authMethod" onchange="toggleAuthFields()">
                            <option value="apikey">APIã‚­ãƒ¼(ç°¡å˜)</option>
                            <option value="oauth">OAuthèªè¨¼(ã‚ˆã‚Šå®‰å…¨)</option>
                        </select>
                    </div>

                    <div id="apiKeyFields">
                        <div class="form-group">
                            <label>Google Sheets API Key *</label>
                            <input type="text" id="apiKey" placeholder="AIzaSy...">
                            <small>Google Cloud Consoleã§å–å¾—ã—ãŸAPIã‚­ãƒ¼ã‚’å…¥åŠ›</small>
                        </div>
                    </div>

                    <div id="oauthFields" style="display: none;">
                        <div class="form-group">
                            <label>OAuth Client ID *</label>
                            <input type="text" id="clientId" placeholder="123456789012-...">
                            <small>Google Cloud Consoleã§å–å¾—ã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’å…¥åŠ›</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID *</label>
                        <input type="text" id="spreadsheetId" placeholder="1BxiMVs0XRA5nFMd...">
                        <small>Google Sheetsã®URLã‹ã‚‰å–å¾—ã—ãŸIDã‚’å…¥åŠ›</small>
                    </div>

                    <div class="form-group">
                        <label>ã‚·ãƒ¼ãƒˆå</label>
                        <input type="text" id="sheetName" value="ã‚·ãƒ¼ãƒˆ1">
                        <small>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå†…ã®ã‚·ãƒ¼ãƒˆå(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ã‚·ãƒ¼ãƒˆ1)</small>
                    </div>

                    <button type="submit" class="btn btn-primary">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
                    <button type="button" class="btn btn-success" onclick="testConnection()" style="margin-top: 10px;">
                        ğŸ” æ¥ç¶šãƒ†ã‚¹ãƒˆ
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="showDebugInfo()" style="margin-top: 10px;">
                        ğŸ› ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
                    </button>
                </form>

                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin-bottom: 10px;">ğŸ“– ã‚¯ã‚¤ãƒƒã‚¯ã‚¬ã‚¤ãƒ‰</h3>
                    <ol style="padding-left: 20px; line-height: 1.8;">
                        <li>Google Cloud Consoleã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨APIã‚­ãƒ¼ã‚’ä½œæˆ</li>
                        <li>Google Sheetsã§æ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ</li>
                        <li>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ã€ã«å…±æœ‰</li>
                        <li>ä¸Šè¨˜ãƒ•ã‚©ãƒ¼ãƒ ã«æƒ…å ±ã‚’å…¥åŠ›</li>
                        <li>ã€Œæ¥ç¶šãƒ†ã‚¹ãƒˆã€ã§å‹•ä½œç¢ºèª</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- è¨­å®šã‚¿ãƒ– -->
        <div id="settings-tab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #667eea;">âš™ï¸ åŸºæœ¬è¨­å®š</h2>
                
                <form id="settingsForm" onsubmit="saveSettings(event)">
                    <div class="form-group">
                        <label>ä½œæ¥­å˜ä¾¡ (å††)</label>
                        <input type="number" id="unitPrice" value="51" step="1" min="0">
                    </div>

                    <div class="form-group">
                        <label>æœˆé¡ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆè²» (å††)</label>
                        <input type="number" id="managementFee" value="1530000" step="1000" min="0">
                    </div>

                    <div class="form-group">
                        <label>é€šå¸¸å˜ä¾¡ (å††/æ™‚)</label>
                        <input type="number" id="normalRate" value="1550" step="10" min="0">
                        <small style="color: #666;">â€»é€šå¸¸å‹¤å‹™: é€šå¸¸å˜ä¾¡Ã—8æ™‚é–“ã§è¨ˆç®—</small>
                    </div>

                    <div class="form-group">
                        <label>å¤œå‹¤å˜ä¾¡ (å††/æ™‚)</label>
                        <input type="number" id="nightRate" value="1938" step="10" min="0">
                        <small style="color: #666;">â€»å¤œå‹¤æ™‚: å¤œå‹¤å˜ä¾¡Ã—6æ™‚é–“ + é€šå¸¸å˜ä¾¡Ã—2æ™‚é–“ã§è¨ˆç®—</small>
                    </div>

                    <button type="submit" class="btn btn-primary">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
                </form>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px; color: #dc3545;">âš ï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
                <p style="margin-top: 10px; color: #666; font-size: 14px;">
                    â€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚å®Ÿè¡Œå‰ã«Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
                </p>
            </div>
        </div>
    </div>

    <script>
        // ========== Google Sheetsè¨­å®š ==========
        // æ³¨æ„: ã“ã®è¨­å®šã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™
        // åˆå›èµ·å‹•æ™‚ã¯ã€ŒGoogle Sheetsè¨­å®šã€ã‚¿ãƒ–ã§è¨­å®šã—ã¦ãã ã•ã„
        // =======================================

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let dailyData = [];
        let editingIndex = -1;
        let settings = {
            unitPrice: 51,
            managementFee: 1530000,
            normalRate: 1550,
            nightRate: 1938
        };
        let sheetsConfig = null;
        let gapiLoaded = false;
        let isOnline = navigator.onLine;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadSheetsConfig();
            loadData();
            setTodayDate();
            updateMonthFilters();
            displayData();
            setupCalculationPreview();
            initGoogleAPI();
            updateSyncStatus();
            
            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ¤œå‡º
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
        });

        // Google APIåˆæœŸåŒ–
        function initGoogleAPI() {
            console.log('=== Google APIåˆæœŸåŒ–é–‹å§‹ ===');
            console.log('Google APIã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹:', typeof gapi !== 'undefined');
            
            if (typeof gapi === 'undefined') {
                console.error('gapiãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Google APIã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                updateSyncStatus('offline', 'APIèª­ã¿è¾¼ã¿å¤±æ•—');
                return;
            }
            
            gapi.load('client', async () => {
                gapiLoaded = true;
                console.log('Google API Client loaded successfully');
                console.log('gapiã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ:', gapi.client);
                
                if (sheetsConfig) {
                    console.log('è¨­å®šãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–ã—ã¾ã™');
                    console.log('è¨­å®šå†…å®¹:', {
                        apiKey: sheetsConfig.apiKey ? sheetsConfig.apiKey.substring(0, 20) + '...' : 'ãªã—',
                        spreadsheetId: sheetsConfig.spreadsheetId,
                        sheetName: sheetsConfig.sheetName
                    });
                    
                    try {
                        await initializeGapiClient();
                    } catch (error) {
                        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                        updateSyncStatus('offline', 'åˆæœŸåŒ–å¤±æ•—');
                    }
                } else {
                    console.log('Google Sheetsè¨­å®šãŒã¾ã ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    updateSyncStatus('offline', 'æœªè¨­å®š');
                }
            });
        }

        // Google APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
        async function initializeGapiClient() {
            if (!gapiLoaded || !sheetsConfig) {
                console.log('åˆæœŸåŒ–ã‚¹ã‚­ãƒƒãƒ—: gapiLoaded=', gapiLoaded, 'sheetsConfig=', !!sheetsConfig);
                return;
            }

            try {
                console.log('=== Google Sheets APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ– ===');
                
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š(20ç§’)
                const timeout = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('åˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ(20ç§’)')), 20000)
                );
                
                const initPromise = (async () => {
                    console.log('gapi.client.init ã‚’å‘¼ã³å‡ºã—ä¸­...');
                    await gapi.client.init({
                        apiKey: sheetsConfig.apiKey,
                    });
                    console.log('gapi.client.init å®Œäº†');
                    
                    console.log('sheets v4 ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                    await gapi.client.load('sheets', 'v4');
                    console.log('sheets v4 èª­ã¿è¾¼ã¿å®Œäº†');
                    
                    console.log('gapi.client.sheets ãŒåˆ©ç”¨å¯èƒ½:', !!gapi.client.sheets);
                })();
                
                await Promise.race([initPromise, timeout]);
                
                console.log('Google Sheets APIåˆæœŸåŒ–æˆåŠŸ');
                updateConfigStatus(true);
                
                // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§æœªåŒæœŸãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸ(ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–)
                syncPendingData().catch(err => {
                    console.log('ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åŒæœŸã‚’ã‚¹ã‚­ãƒƒãƒ—:', err.message);
                });
            } catch (error) {
                console.error('=== Google APIåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ ===');
                console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
                updateConfigStatus(false, error.message);
                
                if (error.message.includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')) {
                    console.error('åˆæœŸåŒ–ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¾ãŸã¯APIã‚­ãƒ¼ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                }
            }
        }

        // è¨­å®šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateConfigStatus(valid, message = '') {
            const statusDiv = document.getElementById('configStatus');
            if (valid) {
                statusDiv.className = 'config-status valid';
                statusDiv.innerHTML = 'âœ… Google Sheetsé€£æºãŒæœ‰åŠ¹ã§ã™';
            } else {
                statusDiv.className = 'config-status invalid';
                statusDiv.innerHTML = `âŒ ${message || 'Google Sheetsé€£æºãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'}`;
            }
        }

        // Google Sheetsè¨­å®šèª­ã¿è¾¼ã¿
        function loadSheetsConfig() {
            const saved = localStorage.getItem('fushimino_sheets_config');
            if (saved) {
                sheetsConfig = JSON.parse(saved);
                document.getElementById('authMethod').value = sheetsConfig.useOAuth ? 'oauth' : 'apikey';
                document.getElementById('apiKey').value = sheetsConfig.apiKey || '';
                document.getElementById('clientId').value = sheetsConfig.clientId || '';
                document.getElementById('spreadsheetId').value = sheetsConfig.spreadsheetId || '';
                document.getElementById('sheetName').value = sheetsConfig.sheetName || 'ã‚·ãƒ¼ãƒˆ1';
                toggleAuthFields();
            }
        }

        // èªè¨¼æ–¹å¼åˆ‡ã‚Šæ›¿ãˆ
        function toggleAuthFields() {
            const method = document.getElementById('authMethod').value;
            const apiKeyFields = document.getElementById('apiKeyFields');
            const oauthFields = document.getElementById('oauthFields');
            
            if (method === 'oauth') {
                apiKeyFields.style.display = 'none';
                oauthFields.style.display = 'block';
            } else {
                apiKeyFields.style.display = 'block';
                oauthFields.style.display = 'none';
            }
        }

        // Google Sheetsè¨­å®šä¿å­˜
        function saveSheetsConfig(event) {
            event.preventDefault();
            
            const method = document.getElementById('authMethod').value;
            const useOAuth = method === 'oauth';
            
            sheetsConfig = {
                useOAuth: useOAuth,
                apiKey: useOAuth ? null : document.getElementById('apiKey').value.trim(),
                clientId: useOAuth ? document.getElementById('clientId').value.trim() : null,
                spreadsheetId: document.getElementById('spreadsheetId').value.trim(),
                sheetName: document.getElementById('sheetName').value.trim() || 'ã‚·ãƒ¼ãƒˆ1'
            };

            if (!sheetsConfig.spreadsheetId) {
                alert('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã¯å¿…é ˆã§ã™');
                return;
            }

            if (!useOAuth && !sheetsConfig.apiKey) {
                alert('APIã‚­ãƒ¼ã¯å¿…é ˆã§ã™');
                return;
            }

            if (useOAuth && !sheetsConfig.clientId) {
                alert('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¯å¿…é ˆã§ã™');
                return;
            }

            localStorage.setItem('fushimino_sheets_config', JSON.stringify(sheetsConfig));
            alert('Google Sheetsè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            
            if (gapiLoaded) {
                console.log('APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å†åˆæœŸåŒ–ã—ã¾ã™');
                initializeGapiClient().catch(err => {
                    console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', err);
                    alert('âš ï¸ è¨­å®šã¯ä¿å­˜ã•ã‚Œã¾ã—ãŸãŒã€åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã€Œæ¥ç¶šãƒ†ã‚¹ãƒˆã€ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚');
                });
            } else {
                alert('Google APIã®èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰ã€Œæ¥ç¶šãƒ†ã‚¹ãƒˆã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
        function showDebugInfo() {
            const info = [];
            
            info.push('=== ã‚·ã‚¹ãƒ†ãƒ æƒ…å ± ===');
            info.push(`ãƒ–ãƒ©ã‚¦ã‚¶: ${navigator.userAgent}`);
            info.push(`ã‚ªãƒ³ãƒ©ã‚¤ãƒ³: ${navigator.onLine ? 'ã¯ã„' : 'ã„ã„ãˆ'}`);
            info.push('');
            
            info.push('=== Google APIçŠ¶æ…‹ ===');
            info.push(`gapiãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹: ${typeof gapi !== 'undefined' ? 'ã¯ã„' : 'ã„ã„ãˆ'}`);
            info.push(`gapiLoaded: ${gapiLoaded ? 'ã¯ã„' : 'ã„ã„ãˆ'}`);
            
            if (typeof gapi !== 'undefined' && gapi.client) {
                info.push(`gapi.client ãŒå­˜åœ¨: ã¯ã„`);
                info.push(`gapi.client.sheets ãŒå­˜åœ¨: ${gapi.client.sheets ? 'ã¯ã„' : 'ã„ã„ãˆ'}`);
            } else {
                info.push(`gapi.client ãŒå­˜åœ¨: ã„ã„ãˆ`);
            }
            info.push('');
            
            info.push('=== Google Sheetsè¨­å®š ===');
            if (sheetsConfig) {
                info.push(`è¨­å®šæ¸ˆã¿: ã¯ã„`);
                info.push(`APIã‚­ãƒ¼: ${sheetsConfig.apiKey ? sheetsConfig.apiKey.substring(0, 20) + '...' : 'ãªã—'}`);
                info.push(`ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID: ${sheetsConfig.spreadsheetId || 'ãªã—'}`);
                info.push(`ã‚·ãƒ¼ãƒˆå: ${sheetsConfig.sheetName || 'ãªã—'}`);
                info.push(`OAuthä½¿ç”¨: ${sheetsConfig.useOAuth ? 'ã¯ã„' : 'ã„ã„ãˆ'}`);
            } else {
                info.push(`è¨­å®šæ¸ˆã¿: ã„ã„ãˆ`);
            }
            info.push('');
            
            info.push('=== ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹ ===');
            info.push(`ç·ãƒ‡ãƒ¼ã‚¿æ•°: ${dailyData.length}ä»¶`);
            info.push(`æœªåŒæœŸãƒ‡ãƒ¼ã‚¿: ${dailyData.filter(d => !d.synced).length}ä»¶`);
            info.push('');
            
            info.push('=== æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ===');
            
            if (typeof gapi === 'undefined') {
                info.push('âŒ Google APIã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                info.push('â†’ ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰(F5)ã—ã¦ãã ã•ã„');
            } else if (!gapiLoaded) {
                info.push('âš ï¸ Google APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒèª­ã¿è¾¼ã¿ä¸­ã§ã™');
                info.push('â†’ æ•°ç§’å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„');
            } else if (!sheetsConfig) {
                info.push('âš ï¸ Google Sheetsè¨­å®šãŒæœªä¿å­˜ã§ã™');
                info.push('â†’ APIã‚­ãƒ¼ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’å…¥åŠ›ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„');
            } else if (!gapi.client.sheets) {
                info.push('âš ï¸ Google Sheets APIãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                info.push('â†’ ã€Œæ¥ç¶šãƒ†ã‚¹ãƒˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
            } else {
                info.push('âœ… ã™ã¹ã¦æ­£å¸¸ã§ã™');
                info.push('â†’ ã€Œæ¥ç¶šãƒ†ã‚¹ãƒˆã€ã§ç¢ºèªã—ã¦ãã ã•ã„');
            }
            
            const debugText = info.join('\n');
            console.log(debugText);
            alert(debugText);
        }

        // æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testConnection() {
            if (!sheetsConfig) {
                alert('å…ˆã«è¨­å®šã‚’ä¿å­˜ã—ã¦ãã ã•ã„');
                return;
            }

            if (!gapiLoaded) {
                alert('Google APIã®èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰(F5)ã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                updateSyncStatus('syncing', 'æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...');
                console.log('=== æ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
                console.log('APIã‚­ãƒ¼:', sheetsConfig.apiKey.substring(0, 20) + '...');
                console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID:', sheetsConfig.spreadsheetId);
                console.log('ã‚·ãƒ¼ãƒˆå:', sheetsConfig.sheetName);
                
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š(30ç§’)
                const timeout = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('æ¥ç¶šãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ(30ç§’)')), 30000)
                );
                
                // APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸåŒ–
                if (!gapi.client.sheets) {
                    console.log('Google Sheets APIã‚’åˆæœŸåŒ–ä¸­...');
                    
                    const initPromise = (async () => {
                        await gapi.client.init({
                            apiKey: sheetsConfig.apiKey,
                        });
                        console.log('gapi.client.init å®Œäº†');
                        
                        await gapi.client.load('sheets', 'v4');
                        console.log('sheets v4 èª­ã¿è¾¼ã¿å®Œäº†');
                    })();
                    
                    await Promise.race([initPromise, timeout]);
                }
                
                console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...');
                
                // ãƒ†ã‚¹ãƒˆèª­ã¿è¾¼ã¿
                const testPromise = gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: sheetsConfig.spreadsheetId,
                    range: `${sheetsConfig.sheetName}!A1:A1`
                });
                
                const response = await Promise.race([testPromise, timeout]);
                
                console.log('æ¥ç¶šæˆåŠŸ!', response);
                updateSyncStatus('synced', 'æ¥ç¶šæˆåŠŸ!');
                alert('âœ… Google Sheetsã¸ã®æ¥ç¶šã«æˆåŠŸã—ã¾ã—ãŸ!');
                updateConfigStatus(true);
            } catch (error) {
                console.error('=== æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ ===');
                console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
                console.error('ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—:', error.constructor.name);
                console.error('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', error.message);
                
                updateSyncStatus('offline', 'æ¥ç¶šå¤±æ•—');
                
                let errorMessage = error.message || 'Unknown error';
                
                // ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if (error.message && error.message.includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')) {
                    errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¾ãŸã¯APIã®å¿œç­”ãŒé…ã™ãã¾ã™ã€‚\n\nå¯¾å‡¦æ³•:\n1. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèª\n2. APIã‚­ãƒ¼ã®åˆ¶é™è¨­å®šã‚’ç¢ºèª\n3. ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ';
                } else if (error.result && error.result.error) {
                    const apiError = error.result.error;
                    errorMessage = apiError.message;
                    
                    if (apiError.code === 403) {
                        errorMessage += '\n\nå¯¾å‡¦æ³•:\n1. APIã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèª\n2. Google Sheets APIãŒæœ‰åŠ¹ã‹ç¢ºèª\n3. APIã‚­ãƒ¼ã®åˆ¶é™ã‚’ç¢ºèª';
                    } else if (apiError.code === 404) {
                        errorMessage += '\n\nå¯¾å‡¦æ³•:\n1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDãŒæ­£ã—ã„ã‹ç¢ºèª\n2. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒå‰Šé™¤ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª';
                    }
                } else if (error.status === 0) {
                    errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: APIã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“\n\nå¯¾å‡¦æ³•:\n1. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèª\n2. ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã‚’ç¢ºèª\n3. VPNã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ç„¡åŠ¹åŒ–ã—ã¦ã¿ã‚‹';
                }
                
                alert('âŒ æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ:\n\n' + errorMessage);
                updateConfigStatus(false, errorMessage);
            }
        }

        // Google Sheetsã«ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        async function saveToGoogleSheets(data) {
            if (!sheetsConfig || !gapiLoaded) {
                throw new Error('Google Sheetsæœªè¨­å®š');
            }

            // APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸåŒ–
            if (!gapi.client.sheets) {
                console.log('Google Sheets APIã‚’åˆæœŸåŒ–ã—ã¾ã™...');
                await gapi.client.init({
                    apiKey: sheetsConfig.apiKey,
                });
                await gapi.client.load('sheets', 'v4');
            }

            const values = [[
                data.date,
                data.workCost,
                data.workFee,
                data.management,
                data.staffCount,
                data.shiftType === 'night' ? 'å¤œå‹¤' : 'é€šå¸¸',
                data.expense,
                data.profit,
                new Date().toISOString()
            ]];

            console.log('=== Google Sheetsä¿å­˜é–‹å§‹ ===');
            console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID:', sheetsConfig.spreadsheetId);
            console.log('ç¯„å›²:', `${sheetsConfig.sheetName}!A:I`);
            console.log('ãƒ‡ãƒ¼ã‚¿:', values);
            
            try {
                const response = await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: sheetsConfig.spreadsheetId,
                    range: `${sheetsConfig.sheetName}!A:I`,
                    valueInputOption: 'RAW',
                    insertDataOption: 'INSERT_ROWS',
                    resource: {
                        values: values
                    }
                });

                console.log('âœ… Google Sheetsä¿å­˜æˆåŠŸ:', response);
                return response;
            } catch (error) {
                console.error('âŒ Google Sheetsä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                console.error('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', error.message);
                console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.result || error);
                
                // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°æƒ…å ±ã‚’å–å¾—
                if (error.result && error.result.error) {
                    console.error('API ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:', error.result.error.code);
                    console.error('API ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', error.result.error.message);
                }
                
                throw error;
            }
        }

        // è¨­å®šã®èª­ã¿è¾¼ã¿
        function loadSettings() {
            const saved = localStorage.getItem('fushimino_settings');
            if (saved) {
                settings = JSON.parse(saved);
                document.getElementById('unitPrice').value = settings.unitPrice;
                document.getElementById('managementFee').value = settings.managementFee;
                document.getElementById('normalRate').value = settings.normalRate;
                document.getElementById('nightRate').value = settings.nightRate;
            }
        }

        // è¨­å®šã®ä¿å­˜
        function saveSettings(event) {
            event.preventDefault();
            settings = {
                unitPrice: parseFloat(document.getElementById('unitPrice').value),
                managementFee: parseFloat(document.getElementById('managementFee').value),
                normalRate: parseFloat(document.getElementById('normalRate').value),
                nightRate: parseFloat(document.getElementById('nightRate').value)
            };
            localStorage.setItem('fushimino_settings', JSON.stringify(settings));
            alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            displayData();
        }

        // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        function loadData() {
            const saved = localStorage.getItem('fushimino_daily_data');
            if (saved) {
                dailyData = JSON.parse(saved);
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
        function saveDataToStorage() {
            localStorage.setItem('fushimino_daily_data', JSON.stringify(dailyData));
        }

        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        // è¨ˆç®—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è¨­å®š
        function setupCalculationPreview() {
            const inputs = ['workCost', 'staffCount', 'shiftType'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', updateCalculationPreview);
                element.addEventListener('change', updateCalculationPreview);
            });
        }

        // è¨ˆç®—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°
        function updateCalculationPreview() {
            const workCost = parseFloat(document.getElementById('workCost').value) || 0;
            const staffCount = parseInt(document.getElementById('staffCount').value) || 0;
            const shiftType = document.getElementById('shiftType').value;

            if (workCost > 0 || staffCount > 0) {
                const calc = calculateValues(null, workCost, staffCount, shiftType);
                
                const previewDiv = document.getElementById('calculation-preview');
                const contentDiv = document.getElementById('preview-content');
                
                contentDiv.innerHTML = `
                    ä½œæ¥­è²»åˆè¨ˆ: <strong>${calc.workFee.toLocaleString()}å††</strong><br>
                    çµŒè²»: <strong>${calc.expense.toLocaleString()}å††</strong><br>
                    åæ”¯: <strong class="${calc.profit >= 0 ? 'positive' : 'negative'}">${calc.profit.toLocaleString()}å††</strong>
                `;
                
                previewDiv.style.display = 'block';
            } else {
                document.getElementById('calculation-preview').style.display = 'none';
            }
        }

        // è¨ˆç®—å‡¦ç†
        function calculateValues(date, workCost, staffCount, shiftType) {
            const workFee = workCost * settings.unitPrice;
            
            let daysInMonth = 30;
            if (date) {
                const d = new Date(date);
                daysInMonth = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
            }
            
            const management = settings.managementFee / daysInMonth;
            
            let expense;
            if (shiftType === 'night') {
                expense = staffCount * (settings.nightRate * 6 + settings.normalRate * 2);
            } else {
                expense = staffCount * settings.normalRate * 8;
            }
            
            const profit = (workFee + management) - expense;

            return {
                workFee: Math.round(workFee),
                management: Math.round(management),
                expense: Math.round(expense),
                profit: Math.round(profit)
            };
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        async function saveData(event) {
            event.preventDefault();

            const date = document.getElementById('date').value;
            const workCost = parseFloat(document.getElementById('workCost').value);
            const staffCount = parseInt(document.getElementById('staffCount').value);
            const shiftType = document.getElementById('shiftType').value;

            const calculated = calculateValues(date, workCost, staffCount, shiftType);

            const data = {
                date: date,
                workCost: workCost,
                staffCount: staffCount,
                shiftType: shiftType,
                ...calculated,
                synced: false,
                syncError: null
            };

            if (editingIndex >= 0) {
                dailyData[editingIndex] = data;
                editingIndex = -1;
            } else {
                dailyData.push(data);
            }

            dailyData.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveDataToStorage();

            // Google Sheetsã«ä¿å­˜ã‚’è©¦è¡Œ
            if (sheetsConfig && isOnline) {
                try {
                    updateSyncStatus('syncing', 'åŒæœŸä¸­...');
                    await saveToGoogleSheets(data);
                    data.synced = true;
                    saveDataToStorage();
                    updateSyncStatus('synced', 'åŒæœŸå®Œäº†');
                    alert('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ(Google Sheetsã«åŒæœŸæ¸ˆã¿)');
                } catch (error) {
                    console.error('åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                    data.syncError = error.message;
                    saveDataToStorage();
                    updateSyncStatus('pending', 'åŒæœŸå¾…ã¡');
                    alert('âš ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸãŒã€Google Sheetsã¸ã®åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸã€‚å¾Œã§æ‰‹å‹•åŒæœŸã—ã¦ãã ã•ã„ã€‚');
                }
            } else {
                updateSyncStatus('pending', 'åŒæœŸå¾…ã¡');
                alert('ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ(ã‚ªãƒ•ãƒ©ã‚¤ãƒ³: å¾Œã§è‡ªå‹•åŒæœŸã•ã‚Œã¾ã™)');
            }
            
            document.getElementById('dataForm').reset();
            setTodayDate();
            document.getElementById('calculation-preview').style.display = 'none';
            document.getElementById('submitBtn').textContent = 'ğŸ’¾ ä¿å­˜';
            
            displayData();
            updateMonthFilters();
        }

        // æœªåŒæœŸãƒ‡ãƒ¼ã‚¿ã®åŒæœŸ
        async function syncPendingData(showAlert = false) {
            if (!sheetsConfig || !isOnline) {
                console.log('åŒæœŸã‚¹ã‚­ãƒƒãƒ—: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã¾ãŸã¯æœªè¨­å®š');
                if (showAlert) {
                    alert('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã¾ãŸã¯Google Sheetsæœªè¨­å®šã§ã™');
                }
                return;
            }

            const pendingData = dailyData.filter(d => !d.synced);
            
            if (pendingData.length === 0) {
                console.log('åŒæœŸå¾…ã¡ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“');
                if (showAlert) {
                    alert('åŒæœŸå¾…ã¡ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“');
                }
                if (isOnline && sheetsConfig) {
                    updateSyncStatus('synced', 'åŒæœŸå®Œäº†');
                }
                return;
            }

            // APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸåŒ–
            if (!gapi.client.sheets) {
                console.log('Google Sheets APIã‚’åˆæœŸåŒ–ã—ã¾ã™...');
                try {
                    await gapi.client.init({
                        apiKey: sheetsConfig.apiKey,
                    });
                    await gapi.client.load('sheets', 'v4');
                } catch (error) {
                    console.error('APIåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                    updateSyncStatus('offline', 'åˆæœŸåŒ–å¤±æ•—');
                    if (showAlert) {
                        alert('âŒ APIåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    }
                    return;
                }
            }

            updateSyncStatus('syncing', `${pendingData.length}ä»¶åŒæœŸä¸­...`);
            
            let successCount = 0;
            let failCount = 0;

            for (const data of pendingData) {
                try {
                    await saveToGoogleSheets(data);
                    data.synced = true;
                    data.syncError = null;
                    successCount++;
                } catch (error) {
                    console.error('åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                    data.syncError = error.message;
                    failCount++;
                }
            }

            saveDataToStorage();
            displayData();
            
            if (failCount === 0) {
                updateSyncStatus('synced', 'åŒæœŸå®Œäº†');
                if (pendingData.length > 0 && showAlert) {
                    alert(`âœ… ${successCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã—ãŸ`);
                }
            } else {
                updateSyncStatus('pending', `${failCount}ä»¶åŒæœŸå¤±æ•—`);
                if (showAlert) {
                    alert(`âš ï¸ ${successCount}ä»¶æˆåŠŸã€${failCount}ä»¶å¤±æ•—ã—ã¾ã—ãŸ`);
                }
            }
        }

        // åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateSyncStatus(status, text) {
            const statusDiv = document.getElementById('syncStatus');
            const statusText = document.getElementById('syncStatusText');
            const spinner = statusDiv.querySelector('.spinner');
            
            statusDiv.className = `sync-status ${status}`;
            statusText.textContent = text || status;
            
            if (status === 'syncing') {
                spinner.style.display = 'inline-block';
            } else {
                spinner.style.display = 'none';
            }
        }

        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®å‡¦ç†
        function handleOnline() {
            isOnline = true;
            updateSyncStatus('synced', 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³');
            syncPendingData();
        }

        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®å‡¦ç†
        function handleOffline() {
            isOnline = false;
            updateSyncStatus('offline', 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³');
        }

        // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        function displayData() {
            const monthFilter = document.getElementById('monthFilter').value;
            let filteredData = dailyData;

            if (monthFilter) {
                filteredData = dailyData.filter(d => d.date.startsWith(monthFilter));
            }

            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            filteredData.forEach((data, index) => {
                const row = tbody.insertRow();
                const actualIndex = dailyData.indexOf(data);
                
                const syncBadge = data.synced ? 
                    '<span style="color: #28a745;">âœ“</span>' : 
                    '<span style="color: #ffc107;">å¾…æ©Ÿ</span>';
                
                row.innerHTML = `
                    <td>${data.date}</td>
                    <td>${data.workCost.toLocaleString()}</td>
                    <td>Â¥${data.workFee.toLocaleString()}</td>
                    <td>Â¥${data.management.toLocaleString()}</td>
                    <td>${data.staffCount}äºº</td>
                    <td>Â¥${data.expense.toLocaleString()}</td>
                    <td class="${data.profit >= 0 ? 'positive' : 'negative'}">Â¥${data.profit.toLocaleString()}</td>
                    <td>${syncBadge}</td>
                    <td>
                        <div class="actions">
                            <button class="btn-small btn-edit" onclick="editData(${actualIndex})">ç·¨é›†</button>
                            <button class="btn-small btn-delete" onclick="deleteData(${actualIndex})">å‰Šé™¤</button>
                        </div>
                    </td>
                `;
            });

            // æœªåŒæœŸãƒ‡ãƒ¼ã‚¿ã‚«ã‚¦ãƒ³ãƒˆ
            const pendingCount = dailyData.filter(d => !d.synced).length;
            if (pendingCount > 0) {
                updateSyncStatus('pending', `${pendingCount}ä»¶åŒæœŸå¾…ã¡`);
            } else if (isOnline && sheetsConfig) {
                updateSyncStatus('synced', 'åŒæœŸå®Œäº†');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ç·¨é›†
        function editData(index) {
            const data = dailyData[index];
            document.getElementById('date').value = data.date;
            document.getElementById('workCost').value = data.workCost;
            document.getElementById('staffCount').value = data.staffCount;
            document.getElementById('shiftType').value = data.shiftType;
            
            editingIndex = index;
            document.getElementById('submitBtn').textContent = 'âœï¸ æ›´æ–°';
            
            switchTab('input');
            window.scrollTo(0, 0);
        }

        // ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelEdit() {
            editingIndex = -1;
            document.getElementById('dataForm').reset();
            setTodayDate();
            document.getElementById('submitBtn').textContent = 'ğŸ’¾ ä¿å­˜';
            document.getElementById('calculation-preview').style.display = 'none';
        }

        // ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        function deleteData(index) {
            if (confirm('ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
                dailyData.splice(index, 1);
                saveDataToStorage();
                displayData();
                updateMonthFilters();
            }
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        function clearAllData() {
            const confirmation = prompt('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚å®Ÿè¡Œã™ã‚‹ã«ã¯ã€Œå‰Šé™¤ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (confirmation === 'å‰Šé™¤') {
                dailyData = [];
                saveDataToStorage();
                displayData();
                updateMonthFilters();
                alert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        // æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ›´æ–°
        function updateMonthFilters() {
            const months = [...new Set(dailyData.map(d => d.date.substring(0, 7)))].sort().reverse();
            
            const monthFilter = document.getElementById('monthFilter');
            const currentMonth = monthFilter.value;
            
            monthFilter.innerHTML = '<option value="">å…¨æœŸé–“</option>';
            
            months.forEach(month => {
                monthFilter.innerHTML += `<option value="${month}">${month}</option>`;
            });
            
            if (currentMonth) monthFilter.value = currentMonth;
        }

        // æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        function filterByMonth() {
            displayData();
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportToExcel() {
            if (dailyData.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const monthFilter = document.getElementById('monthFilter').value;
            let filteredData = dailyData;

            if (monthFilter) {
                filteredData = dailyData.filter(d => d.date.startsWith(monthFilter));
            }

            const exportData = filteredData.map(d => ({
                'æ—¥ä»˜': d.date,
                'ä½œæ¥­Unitæ•°': d.workCost,
                'ä½œæ¥­è²»åˆè¨ˆ': d.workFee,
                'ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ': d.management,
                'äººæ•°': d.staffCount,
                'å‹¤å‹™ç¨®åˆ¥': d.shiftType === 'night' ? 'å¤œå‹¤' : 'é€šå¸¸',
                'çµŒè²»': d.expense,
                'åæ”¯': d.profit,
                'åŒæœŸçŠ¶æ…‹': d.synced ? 'æ¸ˆ' : 'æœª'
            }));

            const totals = {
                'æ—¥ä»˜': 'åˆè¨ˆ',
                'ä½œæ¥­Unitæ•°': '',
                'ä½œæ¥­è²»åˆè¨ˆ': filteredData.reduce((sum, d) => sum + d.workFee, 0),
                'ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ': filteredData.reduce((sum, d) => sum + d.management, 0),
                'äººæ•°': '',
                'å‹¤å‹™ç¨®åˆ¥': '',
                'çµŒè²»': filteredData.reduce((sum, d) => sum + d.expense, 0),
                'åæ”¯': filteredData.reduce((sum, d) => sum + d.profit, 0),
                'åŒæœŸçŠ¶æ…‹': ''
            };
            exportData.push(totals);

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ãµã˜ã¿é‡æ—¥å ±');

            const filename = monthFilter ? 
                `ãµã˜ã¿é‡æ—¥å ±_${monthFilter}.xlsx` : 
                `ãµã˜ã¿é‡æ—¥å ±_å…¨æœŸé–“.xlsx`;

            XLSX.writeFile(wb, filename);
        }
    </script>
</body>
</html>
