<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãµã˜ã¿é‡æ—¥å ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Mequlibri, 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            overflow-x: hidden;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
        }

        .sync-status.synced {
            background: #d4edda;
            color: #155724;
        }

        .sync-status.syncing {
            background: #fff3cd;
            color: #856404;
        }

        .sync-status.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .sync-status.pending {
            background: #d1ecf1;
            color: #0c5460;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab-btn {
            background: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 10px rgba(102,126,234,0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow-x: hidden;
        }

        .form-group {
            margin-bottom: 15px;
            max-width: 100%;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
            font-family: inherit;
            box-sizing: border-box;
            max-width: 100%;
        }

        .form-group input[type="date"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group small {
            color: #666;
            font-size: 12px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            margin-top: 10px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
            margin-top: 10px;
        }

        .btn-success:hover {
            background: #218838;
        }

        .data-table {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        td:first-child, th:first-child {
            text-align: left;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .positive {
            color: #28a745;
            font-weight: 600;
        }

        .negative {
            color: #dc3545;
            font-weight: 600;
        }

        .actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-edit {
            background: #ffc107;
            color: #333;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .month-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .month-selector select {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .header h1 {
                font-size: 20px;
            }

            .header {
                padding: 15px;
            }

            .card {
                padding: 15px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 10px;
                font-size: 16px;
            }

            .tabs {
                justify-content: flex-start;
            }

            .tab-btn {
                padding: 10px 16px;
                font-size: 14px;
            }

            .month-selector {
                flex-direction: column;
            }

            .month-selector select,
            .month-selector button {
                width: 100%;
            }
        }

        .config-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid;
        }

        .config-status.valid {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .config-status.invalid {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(0,0,0,.1);
            border-left-color: currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ãµã˜ã¿é‡æ—¥å ± - Google Sheetsé€£æºç‰ˆ</h1>
            <p>æ—¥ã€…ã®ä½œæ¥­ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ãƒ»è‡ªå‹•åŒæœŸ</p>
            <div id="syncStatus" class="sync-status offline">
                <span class="spinner" style="display: none;"></span>
                <span id="syncStatusText">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('input', event)">ğŸ“ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</button>
            <button class="tab-btn" onclick="switchTab('list', event)">ğŸ“‹ ä¸€è¦§è¡¨ç¤º</button>
            <button class="tab-btn" onclick="switchTab('sheets', event)">ğŸ”— Google Sheetsè¨­å®š</button>
            <button class="tab-btn" onclick="switchTab('settings', event)">âš™ï¸ è¨­å®š</button>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã‚¿ãƒ– -->
        <div id="input-tab" class="tab-content active">
            <div class="card">
                <form id="dataForm" onsubmit="saveData(event)">
                    <div class="form-group">
                        <label>æ—¥ä»˜ *</label>
                        <input type="date" id="date" required>
                    </div>

                    <div class="form-group">
                        <label>ä½œæ¥­Unitæ•° *</label>
                        <input type="number" id="workCost" placeholder="ä¾‹: 7000" required step="1" min="0">
                    </div>

                    <div class="form-group">
                        <label>äººæ•° *</label>
                        <input type="number" id="staffCount" placeholder="ä¾‹: 20" required step="1" min="0">
                    </div>

                    <div class="form-group">
                        <label>å‹¤å‹™ç¨®åˆ¥ *</label>
                        <select id="shiftType" required>
                            <option value="night">å¤œå‹¤</option>
                            <option value="normal">é€šå¸¸å‹¤å‹™</option>
                        </select>
                    </div>

                    <div class="alert alert-info" id="calculation-preview" style="display: none;">
                        <strong>è¨ˆç®—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</strong>
                        <div id="preview-content" style="margin-top: 10px;"></div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="submitBtn">ğŸ’¾ ä¿å­˜</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelEdit()">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </form>
            </div>
        </div>

        <!-- ä¸€è¦§è¡¨ç¤ºã‚¿ãƒ– -->
        <div id="list-tab" class="tab-content">
            <div class="card">
                <div class="month-selector">
                    <select id="monthFilter" onchange="filterByMonth()">
                        <option value="">å…¨æœŸé–“</option>
                    </select>
                    <button class="btn btn-secondary" onclick="exportToExcel()" style="width: auto; padding: 10px 20px;">
                        ğŸ“¥ Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn btn-success" onclick="syncPendingData(true)" style="width: auto; padding: 10px 20px;">
                        ğŸ”„ æ‰‹å‹•åŒæœŸ
                    </button>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>ä½œæ¥­Unitæ•°</th>
                                <th>ä½œæ¥­è²»åˆè¨ˆ</th>
                                <th>ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ</th>
                                <th>äººæ•°</th>
                                <th>çµŒè²»</th>
                                <th>åæ”¯</th>
                                <th>åŒæœŸ</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Google Sheetsè¨­å®šã‚¿ãƒ– -->
        <div id="sheets-tab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #667eea;">ğŸ”— Google Sheetsé€£æºè¨­å®š</h2>
                
                <div id="configStatus" class="config-status invalid">
                    âŒ Google Sheetsé€£æºãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“
                </div>

                <div class="alert alert-info">
                    <strong>ğŸ“š Google Apps Scriptè¨­å®šæ‰‹é †</strong><br>
                    1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ã€Œæ‹¡å¼µæ©Ÿèƒ½ã€â†’ã€ŒApps Scriptã€ã‚’é–‹ã<br>
                    2. æä¾›ã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘<br>
                    3. ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€â†’ã€Œæ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã€â†’ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã€<br>
                    4. ã€Œã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚’ã€Œå…¨å“¡ã€ã«è¨­å®š<br>
                    5. ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä¸‹è¨˜ã«å…¥åŠ›
                </div>

                <div class="alert alert-warning">
                    <strong>âš ï¸ ã‚ˆãã‚ã‚‹å•é¡Œ</strong><br>
                    <ul style="margin: 10px 0 0 20px; padding: 0;">
                        <li>ã€Œæ¥ç¶šãƒ†ã‚¹ãƒˆã€ãŒå¤±æ•— â†’ URLãŒæ­£ã—ã„ã‹ç¢ºèª</li>
                        <li>ã€ŒPermission deniedã€â†’ ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã§ã€Œå…¨å“¡ã€ã‚’é¸æŠ</li>
                        <li>ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã®SHEET_NAMEã‚’å®Ÿéš›ã®ã‚·ãƒ¼ãƒˆåã«å¤‰æ›´</li>
                    </ul>
                </div>

                <form id="sheetsConfigForm" onsubmit="saveSheetsConfig(event)">
                    <div class="form-group">
                        <label>Google Apps Script URL *</label>
                        <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/AKfycby.../exec">
                        <small>Apps Scriptã‚’ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸå¾Œã®URLã‚’å…¥åŠ›</small>
                    </div>

                    <button type="submit" class="btn btn-primary">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
                    <button type="button" class="btn btn-success" onclick="testConnection()" style="margin-top: 10px;">
                        ğŸ” æ¥ç¶šãƒ†ã‚¹ãƒˆ
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="showDebugInfo()" style="margin-top: 10px;">
                        ğŸ› ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="lockSheetsConfig()" style="margin-top: 10px; background: #dc3545;">
                        ğŸ”’ è¨­å®šã‚’ãƒ­ãƒƒã‚¯
                    </button>
                </form>

                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin-bottom: 10px;">ğŸ“– ã‚¯ã‚¤ãƒƒã‚¯ã‚¬ã‚¤ãƒ‰</h3>
                    <ol style="padding-left: 20px; line-height: 1.8;">
                        <li>å¯¾è±¡ã®Google Sheetsã‚’é–‹ã</li>
                        <li>ã€Œæ‹¡å¼µæ©Ÿèƒ½ã€â†’ã€ŒApps Scriptã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>æä¾›ã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ï¼ˆSHEET_NAMEã‚’å®Ÿéš›ã®ã‚·ãƒ¼ãƒˆåã«å¤‰æ›´ï¼‰</li>
                        <li>ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€â†’ã€Œæ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã€â†’ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã€ã‚’é¸æŠ</li>
                        <li>ã€Œã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚’ã€Œå…¨å“¡ã€ã«è¨­å®šã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤</li>
                        <li>ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®URLï¼ˆ.../exec ã§çµ‚ã‚ã‚‹URLï¼‰ã‚’ã‚³ãƒ”ãƒ¼</li>
                        <li>ä¸Šè¨˜ãƒ•ã‚©ãƒ¼ãƒ ã«URLã‚’è²¼ã‚Šä»˜ã‘</li>
                        <li>ã€Œæ¥ç¶šãƒ†ã‚¹ãƒˆã€ã§å‹•ä½œç¢ºèª</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- è¨­å®šã‚¿ãƒ– -->
        <div id="settings-tab" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #667eea;">âš™ï¸ åŸºæœ¬è¨­å®š</h2>
                
                <form id="settingsForm" onsubmit="saveSettings(event)">
                    <div class="form-group">
                        <label>ä½œæ¥­å˜ä¾¡ (å††)</label>
                        <input type="number" id="unitPrice" value="51" step="1" min="0">
                    </div>

                    <div class="form-group">
                        <label>æœˆé¡ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆè²» (å††)</label>
                        <input type="number" id="managementFee" value="1530000" step="1000" min="0">
                    </div>

                    <div class="form-group">
                        <label>é€šå¸¸å˜ä¾¡ (å††/æ™‚)</label>
                        <input type="number" id="normalRate" value="1550" step="10" min="0">
                        <small style="color: #666;">â€»é€šå¸¸å‹¤å‹™: é€šå¸¸å˜ä¾¡Ã—8æ™‚é–“ã§è¨ˆç®—</small>
                    </div>

                    <div class="form-group">
                        <label>å¤œå‹¤å˜ä¾¡ (å††/æ™‚)</label>
                        <input type="number" id="nightRate" value="1938" step="10" min="0">
                        <small style="color: #666;">â€»å¤œå‹¤æ™‚: å¤œå‹¤å˜ä¾¡Ã—6æ™‚é–“ + é€šå¸¸å˜ä¾¡Ã—2æ™‚é–“ã§è¨ˆç®—</small>
                    </div>

                    <button type="submit" class="btn btn-primary">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
                </form>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px; color: #dc3545;">âš ï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
                <p style="margin-top: 10px; color: #666; font-size: 14px;">
                    â€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚å®Ÿè¡Œå‰ã«Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
                </p>
            </div>
        </div>
    </div>

    <script>
        // ========== Google Sheetsè¨­å®š ==========
        // æ³¨æ„: ã“ã®è¨­å®šã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™
        // åˆå›èµ·å‹•æ™‚ã¯ã€ŒGoogle Sheetsè¨­å®šã€ã‚¿ãƒ–ã§è¨­å®šã—ã¦ãã ã•ã„
        // =======================================

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let dailyData = [];
        let editingIndex = -1;
        let settings = {
            unitPrice: 51,
            managementFee: 1530000,
            normalRate: 1550,
            nightRate: 1938
        };
        let sheetsConfig = null;
        let isOnline = navigator.onLine;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadSheetsConfig();
            loadData();
            setTodayDate();
            updateMonthFilters();
            displayData();
            setupCalculationPreview();
            
            // åˆæœŸåŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š
            if (!sheetsConfig) {
                updateSyncStatus('offline', 'æœªè¨­å®š');
            } else if (isOnline) {
                updateSyncStatus('synced', 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³');
            } else {
                updateSyncStatus('offline', 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³');
            }
            
            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ¤œå‡º
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
        });

        // æ—¥æœ¬æ™‚é–“ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å–å¾—
        function getJSTTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // è¨­å®šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateConfigStatus(valid, message = '') {
            const statusDiv = document.getElementById('configStatus');
            if (valid) {
                statusDiv.className = 'config-status valid';
                statusDiv.innerHTML = 'âœ… Google Sheetsé€£æºãŒæœ‰åŠ¹ã§ã™';
            } else {
                statusDiv.className = 'config-status invalid';
                statusDiv.innerHTML = `âŒ ${message || 'Google Sheetsé€£æºãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'}`;
            }
        }

        // Google Sheetsè¨­å®šèª­ã¿è¾¼ã¿
        function loadSheetsConfig() {
            const saved = localStorage.getItem('fushimino_sheets_config');
            if (saved) {
                sheetsConfig = JSON.parse(saved);
                document.getElementById('scriptUrl').value = sheetsConfig.scriptUrl || '';
            }
        }

        // Google Sheetsè¨­å®šä¿å­˜
        function saveSheetsConfig(event) {
            event.preventDefault();
            
            const scriptUrl = document.getElementById('scriptUrl').value.trim();
            
            if (!scriptUrl) {
                alert('Google Apps Script URLã¯å¿…é ˆã§ã™');
                return;
            }

            if (!scriptUrl.includes('script.google.com') || !scriptUrl.includes('/exec')) {
                alert('URLãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚Apps Scriptã®ãƒ‡ãƒ—ãƒ­ã‚¤ URLï¼ˆ/exec ã§çµ‚ã‚ã‚‹ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            sheetsConfig = {
                scriptUrl: scriptUrl
            };

            localStorage.setItem('fushimino_sheets_config', JSON.stringify(sheetsConfig));
            alert('Google Apps Scriptè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            updateConfigStatus(true);
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
        function showDebugInfo() {
            const info = [];
            
            info.push('=== ã‚·ã‚¹ãƒ†ãƒ æƒ…å ± ===');
            info.push(`ãƒ–ãƒ©ã‚¦ã‚¶: ${navigator.userAgent}`);
            info.push(`ã‚ªãƒ³ãƒ©ã‚¤ãƒ³: ${navigator.onLine ? 'ã¯ã„' : 'ã„ã„ãˆ'}`);
            info.push('');
            
            info.push('=== Google Apps Scriptè¨­å®š ===');
            if (sheetsConfig) {
                info.push(`è¨­å®šæ¸ˆã¿: ã¯ã„`);
                info.push(`Script URL: ${sheetsConfig.scriptUrl || 'ãªã—'}`);
            } else {
                info.push(`è¨­å®šæ¸ˆã¿: ã„ã„ãˆ`);
            }
            info.push('');
            
            info.push('=== ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹ ===');
            info.push(`ç·ãƒ‡ãƒ¼ã‚¿æ•°: ${dailyData.length}ä»¶`);
            info.push(`æœªåŒæœŸãƒ‡ãƒ¼ã‚¿: ${dailyData.filter(d => !d.synced).length}ä»¶`);
            info.push('');
            
            info.push('=== æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ===');
            
            if (!sheetsConfig) {
                info.push('âš ï¸ Google Apps Scriptè¨­å®šãŒæœªä¿å­˜ã§ã™');
                info.push('â†’ Script URLã‚’å…¥åŠ›ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„');
            } else {
                info.push('âœ… è¨­å®šã¯ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™');
                info.push('â†’ ã€Œæ¥ç¶šãƒ†ã‚¹ãƒˆã€ã§ç¢ºèªã—ã¦ãã ã•ã„');
            }
            
            const debugText = info.join('\n');
            console.log(debugText);
            alert(debugText);
        }

        // Google Sheetsè¨­å®šã‚’ãƒ­ãƒƒã‚¯
        function lockSheetsConfig() {
            const confirmLock = confirm('Google Sheetsè¨­å®šã‚’ãƒ­ãƒƒã‚¯ã—ã¾ã™ã€‚\n\næ¬¡å›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚\n\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');
            
            if (confirmLock) {
                // èªè¨¼æƒ…å ±ã‚’ã‚¯ãƒªã‚¢
                sessionStorage.removeItem('sheets_config_auth');
                
                alert('ğŸ”’ Google Sheetsè¨­å®šã‚’ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸã€‚\n\næ¬¡å›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚');
                
                // ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã‚¿ãƒ–ã«ç§»å‹•
                switchTab('input', null);
            }
        }

        // æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testConnection() {
            if (!sheetsConfig || !sheetsConfig.scriptUrl) {
                alert('å…ˆã«Google Apps Script URLã‚’è¨­å®šã—ã¦ãã ã•ã„');
                return;
            }

            // æ–°ã—ã„ã‚¿ãƒ–ã§URLã‚’é–‹ã„ã¦æ‰‹å‹•ç¢ºèª
            const confirmOpen = confirm(
                'æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™ã€‚\n\n' +
                'Apps Script URLã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã™ã€‚\n' +
                'JSONãŒè¡¨ç¤ºã•ã‚Œã‚Œã°æ¥ç¶šæˆåŠŸã§ã™ã€‚\n\n' +
                'é–‹ãã¾ã™ã‹ï¼Ÿ'
            );
            
            if (confirmOpen) {
                window.open(sheetsConfig.scriptUrl, '_blank');
                
                // 3ç§’å¾Œã«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
                setTimeout(() => {
                    const success = confirm(
                        'æ–°ã—ã„ã‚¿ãƒ–ã§JSONãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã‹ï¼Ÿ\n\n' +
                        'âœ… ã€ŒOKã€ = æ¥ç¶šæˆåŠŸï¼ˆJSONãŒè¡¨ç¤ºã•ã‚ŒãŸï¼‰\n' +
                        'âŒ ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ = æ¥ç¶šå¤±æ•—'
                    );
                    
                    if (success) {
                        updateSyncStatus('synced', 'æ¥ç¶šæˆåŠŸ!');
                        updateConfigStatus(true);
                        alert('âœ… æ¥ç¶šãƒ†ã‚¹ãƒˆã«æˆåŠŸã—ã¾ã—ãŸï¼\n\nãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¨åŒæœŸãŒå¯èƒ½ã§ã™ã€‚');
                    } else {
                        updateSyncStatus('offline', 'æ¥ç¶šå¤±æ•—');
                        updateConfigStatus(false);
                        alert('âŒ æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nå¯¾å‡¦æ³•:\n1. Apps ScriptãŒæ­£ã—ããƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª\n2. ã€Œã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ãŒã€Œå…¨å“¡ã€ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª\n3. URLãŒæ­£ã—ã„ã‹ç¢ºèª');
                    }
                }, 3000);
            }
        }

        // Google Sheetsã«ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆApps ScriptçµŒç”± - GETãƒªã‚¯ã‚¨ã‚¹ãƒˆ + iframeï¼‰
        async function saveToGoogleSheets(data) {
            if (!sheetsConfig || !sheetsConfig.scriptUrl) {
                throw new Error('Google Apps Scriptæœªè¨­å®š');
            }

            console.log('=== Google Sheetsä¿å­˜é–‹å§‹ (GET+iframeæ–¹å¼) ===');
            console.log('Script URL:', sheetsConfig.scriptUrl);
            console.log('ãƒ‡ãƒ¼ã‚¿:', data);
            
            return new Promise((resolve, reject) => {
                try {
                    // GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã®URLã‚’ä½œæˆï¼ˆã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦é€ä¿¡ï¼‰
                    const params = new URLSearchParams();
                    params.append('action', 'addData');
                    params.append('data', JSON.stringify(data));
                    
                    const url = `${sheetsConfig.scriptUrl}?${params.toString()}`;
                    
                    console.log('é€ä¿¡URL:', url);
                    
                    // éš ã—iframeã‚’ä½œæˆ
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.name = 'hiddenFrame_' + Date.now();
                    document.body.appendChild(iframe);
                    
                    // iframeã§URLã‚’é–‹ã
                    iframe.src = url;
                    
                    console.log('âœ… ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å®Œäº†');

                    // é€ä¿¡å®Œäº†ã‚’å¾…æ©Ÿï¼ˆ3ç§’å¾Œã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
                    setTimeout(() => {
                        document.body.removeChild(iframe);
                        console.log('âœ… Google Sheetsä¿å­˜å®Œäº†ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰');
                        resolve({ success: true });
                    }, 3000);

                } catch (error) {
                    console.error('âŒ Google Sheetsä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    console.error('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', error.message);
                    reject(error);
                }
            });
        }


        // è¨­å®šã®èª­ã¿è¾¼ã¿
        function loadSettings() {
            const saved = localStorage.getItem('fushimino_settings');
            if (saved) {
                settings = JSON.parse(saved);
                document.getElementById('unitPrice').value = settings.unitPrice;
                document.getElementById('managementFee').value = settings.managementFee;
                document.getElementById('normalRate').value = settings.normalRate;
                document.getElementById('nightRate').value = settings.nightRate;
            }
        }

        // è¨­å®šã®ä¿å­˜
        function saveSettings(event) {
            event.preventDefault();
            settings = {
                unitPrice: parseFloat(document.getElementById('unitPrice').value),
                managementFee: parseFloat(document.getElementById('managementFee').value),
                normalRate: parseFloat(document.getElementById('normalRate').value),
                nightRate: parseFloat(document.getElementById('nightRate').value)
            };
            localStorage.setItem('fushimino_settings', JSON.stringify(settings));
            alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            displayData();
        }

        // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        function loadData() {
            const saved = localStorage.getItem('fushimino_daily_data');
            if (saved) {
                dailyData = JSON.parse(saved);
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
        function saveDataToStorage() {
            localStorage.setItem('fushimino_daily_data', JSON.stringify(dailyData));
        }

        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰
        function setTodayDate() {
            const dateInput = document.getElementById('date');
            if (dateInput) {
                // æ—¥æœ¬æ™‚é–“ï¼ˆJST = UTC+9ï¼‰ã§ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
                const now = new Date();
                const jstOffset = 9 * 60; // 9æ™‚é–“ = 540åˆ†
                const jstTime = new Date(now.getTime() + (jstOffset - now.getTimezoneOffset()) * 60000);
                const today = jstTime.toISOString().split('T')[0];
                dateInput.value = today;
            }
        }

        // è¨ˆç®—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è¨­å®š
        function setupCalculationPreview() {
            const inputs = ['workCost', 'staffCount', 'shiftType'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateCalculationPreview);
                    element.addEventListener('change', updateCalculationPreview);
                }
            });
        }

        // è¨ˆç®—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°
        function updateCalculationPreview() {
            const workCostInput = document.getElementById('workCost');
            const staffCountInput = document.getElementById('staffCount');
            const shiftTypeInput = document.getElementById('shiftType');
            const previewDiv = document.getElementById('calculation-preview');
            const contentDiv = document.getElementById('preview-content');
            
            if (!workCostInput || !staffCountInput || !shiftTypeInput || !previewDiv || !contentDiv) {
                return;
            }
            
            const workCost = parseFloat(workCostInput.value) || 0;
            const staffCount = parseInt(staffCountInput.value) || 0;
            const shiftType = shiftTypeInput.value;

            if (workCost > 0 || staffCount > 0) {
                const calc = calculateValues(null, workCost, staffCount, shiftType);
                
                contentDiv.innerHTML = `
                    ä½œæ¥­è²»åˆè¨ˆ: <strong>${calc.workFee.toLocaleString()}å††</strong><br>
                    çµŒè²»: <strong>${calc.expense.toLocaleString()}å††</strong><br>
                    åæ”¯: <strong class="${calc.profit >= 0 ? 'positive' : 'negative'}">${calc.profit.toLocaleString()}å††</strong>
                `;
                
                previewDiv.style.display = 'block';
            } else {
                previewDiv.style.display = 'none';
            }
        }

        // è¨ˆç®—å‡¦ç†
        function calculateValues(date, workCost, staffCount, shiftType) {
            const workFee = workCost * settings.unitPrice;
            
            let daysInMonth = 30;
            if (date) {
                const d = new Date(date);
                daysInMonth = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
            }
            
            const management = settings.managementFee / daysInMonth;
            
            let expense;
            if (shiftType === 'night') {
                expense = staffCount * (settings.nightRate * 6 + settings.normalRate * 2);
            } else {
                expense = staffCount * settings.normalRate * 8;
            }
            
            const profit = (workFee + management) - expense;

            return {
                workFee: Math.round(workFee),
                management: Math.round(management),
                expense: Math.round(expense),
                profit: Math.round(profit)
            };
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        async function saveData(event) {
            event.preventDefault();

            const dateInput = document.getElementById('date');
            const workCostInput = document.getElementById('workCost');
            const staffCountInput = document.getElementById('staffCount');
            const shiftTypeInput = document.getElementById('shiftType');
            
            if (!dateInput || !workCostInput || !staffCountInput || !shiftTypeInput) {
                alert('å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            const date = dateInput.value;
            const workCost = parseFloat(workCostInput.value);
            const staffCount = parseInt(staffCountInput.value);
            const shiftType = shiftTypeInput.value;

            const calculated = calculateValues(date, workCost, staffCount, shiftType);

            const data = {
                date: date,
                workCost: workCost,
                staffCount: staffCount,
                shiftType: shiftType,
                ...calculated,
                timestamp: getJSTTimestamp(), // æ—¥æœ¬æ™‚é–“ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ 
                synced: false,
                syncError: null
            };

            if (editingIndex >= 0) {
                dailyData[editingIndex] = data;
                editingIndex = -1;
            } else {
                dailyData.push(data);
            }

            dailyData.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveDataToStorage();

            // Google Sheetsã«ä¿å­˜ã‚’è©¦è¡Œ
            if (sheetsConfig && isOnline) {
                try {
                    updateSyncStatus('syncing', 'åŒæœŸä¸­...');
                    await saveToGoogleSheets(data);
                    data.synced = true;
                    saveDataToStorage();
                    updateSyncStatus('synced', 'åŒæœŸå®Œäº†');
                    alert('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ\n\nGoogle Sheetsã¸é€ä¿¡å®Œäº†ã—ã¾ã—ãŸã€‚\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã„ã¦ã€ãƒ‡ãƒ¼ã‚¿ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } catch (error) {
                    console.error('åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                    data.syncError = error.message;
                    saveDataToStorage();
                    updateSyncStatus('pending', 'åŒæœŸå¾…ã¡');
                    alert('âš ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸãŒã€Google Sheetsã¸ã®åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸã€‚å¾Œã§æ‰‹å‹•åŒæœŸã—ã¦ãã ã•ã„ã€‚');
                }
            } else {
                updateSyncStatus('pending', 'åŒæœŸå¾…ã¡');
                alert('ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ(ã‚ªãƒ•ãƒ©ã‚¤ãƒ³: å¾Œã§è‡ªå‹•åŒæœŸã•ã‚Œã¾ã™)');
            }
            
            const dataForm = document.getElementById('dataForm');
            const preview = document.getElementById('calculation-preview');
            const submitBtn = document.getElementById('submitBtn');
            
            if (dataForm) dataForm.reset();
            setTodayDate();
            if (preview) preview.style.display = 'none';
            if (submitBtn) submitBtn.textContent = 'ğŸ’¾ ä¿å­˜';
            
            displayData();
            updateMonthFilters();
        }

        // æœªåŒæœŸãƒ‡ãƒ¼ã‚¿ã®åŒæœŸ
        async function syncPendingData(showAlert = false) {
            if (!sheetsConfig || !isOnline) {
                console.log('åŒæœŸã‚¹ã‚­ãƒƒãƒ—: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã¾ãŸã¯æœªè¨­å®š');
                if (showAlert) {
                    alert('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã¾ãŸã¯Google Apps Scriptæœªè¨­å®šã§ã™');
                }
                return;
            }

            const pendingData = dailyData.filter(d => !d.synced);
            
            if (pendingData.length === 0) {
                console.log('åŒæœŸå¾…ã¡ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“');
                if (showAlert) {
                    alert('åŒæœŸå¾…ã¡ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“');
                }
                if (isOnline && sheetsConfig) {
                    updateSyncStatus('synced', 'åŒæœŸå®Œäº†');
                }
                return;
            }

            updateSyncStatus('syncing', `${pendingData.length}ä»¶åŒæœŸä¸­...`);
            
            let successCount = 0;
            let failCount = 0;

            for (const data of pendingData) {
                try {
                    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒãªã„å ´åˆã¯è¿½åŠ ï¼ˆå¤ã„ãƒ‡ãƒ¼ã‚¿å¯¾å¿œï¼‰
                    if (!data.timestamp) {
                        data.timestamp = getJSTTimestamp();
                    }
                    await saveToGoogleSheets(data);
                    data.synced = true;
                    data.syncError = null;
                    successCount++;
                } catch (error) {
                    console.error('åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                    data.syncError = error.message;
                    failCount++;
                }
            }

            saveDataToStorage();
            displayData();
            
            if (failCount === 0) {
                updateSyncStatus('synced', 'åŒæœŸå®Œäº†');
                if (pendingData.length > 0 && showAlert) {
                    alert(`âœ… ${successCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã—ãŸ\n\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã„ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                }
            } else {
                updateSyncStatus('pending', `${failCount}ä»¶åŒæœŸå¤±æ•—`);
                if (showAlert) {
                    alert(`âš ï¸ ${successCount}ä»¶æˆåŠŸã€${failCount}ä»¶å¤±æ•—ã—ã¾ã—ãŸ\n\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§æˆåŠŸã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                }
            }
        }

        // åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateSyncStatus(status, text) {
            const statusDiv = document.getElementById('syncStatus');
            const statusText = document.getElementById('syncStatusText');
            
            if (!statusDiv || !statusText) {
                console.warn('åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const spinner = statusDiv.querySelector('.spinner');
            
            statusDiv.className = `sync-status ${status}`;
            statusText.textContent = text || status;
            
            if (spinner) {
                if (status === 'syncing') {
                    spinner.style.display = 'inline-block';
                } else {
                    spinner.style.display = 'none';
                }
            }
        }

        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®å‡¦ç†
        function handleOnline() {
            isOnline = true;
            updateSyncStatus('synced', 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³');
            syncPendingData();
        }

        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®å‡¦ç†
        function handleOffline() {
            isOnline = false;
            updateSyncStatus('offline', 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³');
        }

        // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        function displayData() {
            const monthFilter = document.getElementById('monthFilter');
            const tbody = document.getElementById('dataTableBody');
            
            if (!monthFilter || !tbody) {
                console.warn('è¡¨ç¤ºè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            let filteredData = dailyData;

            if (monthFilter.value) {
                filteredData = dailyData.filter(d => d.date.startsWith(monthFilter.value));
            }

            tbody.innerHTML = '';

            filteredData.forEach((data, index) => {
                const row = tbody.insertRow();
                const actualIndex = dailyData.indexOf(data);
                
                const syncBadge = data.synced ? 
                    '<span style="color: #28a745;">âœ“</span>' : 
                    '<span style="color: #ffc107;">å¾…æ©Ÿ</span>';
                
                row.innerHTML = `
                    <td>${data.date}</td>
                    <td>${data.workCost.toLocaleString()}</td>
                    <td>Â¥${data.workFee.toLocaleString()}</td>
                    <td>Â¥${data.management.toLocaleString()}</td>
                    <td>${data.staffCount}äºº</td>
                    <td>Â¥${data.expense.toLocaleString()}</td>
                    <td class="${data.profit >= 0 ? 'positive' : 'negative'}">Â¥${data.profit.toLocaleString()}</td>
                    <td>${syncBadge}</td>
                    <td>
                        <div class="actions">
                            <button class="btn-small btn-edit" onclick="editData(${actualIndex})">ç·¨é›†</button>
                            <button class="btn-small btn-delete" onclick="deleteData(${actualIndex})">å‰Šé™¤</button>
                        </div>
                    </td>
                `;
            });

            // æœªåŒæœŸãƒ‡ãƒ¼ã‚¿ã‚«ã‚¦ãƒ³ãƒˆ
            const pendingCount = dailyData.filter(d => !d.synced).length;
            if (pendingCount > 0) {
                updateSyncStatus('pending', `${pendingCount}ä»¶åŒæœŸå¾…ã¡`);
            } else if (isOnline && sheetsConfig) {
                updateSyncStatus('synced', 'åŒæœŸå®Œäº†');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ç·¨é›†
        function editData(index) {
            const data = dailyData[index];
            const dateInput = document.getElementById('date');
            const workCostInput = document.getElementById('workCost');
            const staffCountInput = document.getElementById('staffCount');
            const shiftTypeInput = document.getElementById('shiftType');
            const submitBtn = document.getElementById('submitBtn');
            
            if (dateInput) dateInput.value = data.date;
            if (workCostInput) workCostInput.value = data.workCost;
            if (staffCountInput) staffCountInput.value = data.staffCount;
            if (shiftTypeInput) shiftTypeInput.value = data.shiftType;
            
            editingIndex = index;
            if (submitBtn) submitBtn.textContent = 'âœï¸ æ›´æ–°';
            
            // å…¥åŠ›ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
            switchTab('input');
            
            // å…¥åŠ›ã‚¿ãƒ–ã®ãƒœã‚¿ãƒ³ã‚’æ‰‹å‹•ã§ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes('ãƒ‡ãƒ¼ã‚¿å…¥åŠ›')) {
                    btn.classList.add('active');
                }
            });
            
            window.scrollTo(0, 0);
        }

        // ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelEdit() {
            editingIndex = -1;
            const dataForm = document.getElementById('dataForm');
            const submitBtn = document.getElementById('submitBtn');
            const preview = document.getElementById('calculation-preview');
            
            if (dataForm) dataForm.reset();
            setTodayDate();
            if (submitBtn) submitBtn.textContent = 'ğŸ’¾ ä¿å­˜';
            if (preview) preview.style.display = 'none';
        }

        // ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        function deleteData(index) {
            if (confirm('ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
                dailyData.splice(index, 1);
                saveDataToStorage();
                displayData();
                updateMonthFilters();
            }
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        function clearAllData() {
            const confirmation = prompt('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚å®Ÿè¡Œã™ã‚‹ã«ã¯ã€Œå‰Šé™¤ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (confirmation === 'å‰Šé™¤') {
                dailyData = [];
                saveDataToStorage();
                displayData();
                updateMonthFilters();
                alert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        // æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ›´æ–°
        function updateMonthFilters() {
            const monthFilter = document.getElementById('monthFilter');
            
            if (!monthFilter) {
                console.warn('monthFilterè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const months = [...new Set(dailyData.map(d => d.date.substring(0, 7)))].sort().reverse();
            const currentMonth = monthFilter.value;
            
            monthFilter.innerHTML = '<option value="">å…¨æœŸé–“</option>';
            
            months.forEach(month => {
                monthFilter.innerHTML += `<option value="${month}">${month}</option>`;
            });
            
            if (currentMonth) monthFilter.value = currentMonth;
        }

        // æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        function filterByMonth() {
            displayData();
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName, event) {
            // Google Sheetsè¨­å®šã‚¿ãƒ–ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
            if (tabName === 'sheets') {
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã«æ—¢ã«èªè¨¼æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
                const isAuthenticated = sessionStorage.getItem('sheets_config_auth') === 'true';
                
                if (!isAuthenticated) {
                    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¦æ±‚
                    const password = prompt('Google Sheetsè¨­å®šã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                    
                    if (password !== '123') {
                        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                        return; // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã‚’ä¸­æ­¢
                    }
                    
                    // èªè¨¼æˆåŠŸ - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
                    sessionStorage.setItem('sheets_config_auth', 'true');
                }
            }
            
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // æŒ‡å®šã•ã‚ŒãŸã‚¿ãƒ–ã‚’è¡¨ç¤º
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        // Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportToExcel() {
            if (dailyData.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const monthFilter = document.getElementById('monthFilter').value;
            let filteredData = dailyData;

            if (monthFilter) {
                filteredData = dailyData.filter(d => d.date.startsWith(monthFilter));
            }

            const exportData = filteredData.map(d => ({
                'æ—¥ä»˜': d.date,
                'ä½œæ¥­Unitæ•°': d.workCost,
                'ä½œæ¥­è²»åˆè¨ˆ': d.workFee,
                'ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ': d.management,
                'äººæ•°': d.staffCount,
                'å‹¤å‹™ç¨®åˆ¥': d.shiftType === 'night' ? 'å¤œå‹¤' : 'é€šå¸¸',
                'çµŒè²»': d.expense,
                'åæ”¯': d.profit,
                'åŒæœŸçŠ¶æ…‹': d.synced ? 'æ¸ˆ' : 'æœª'
            }));

            const totals = {
                'æ—¥ä»˜': 'åˆè¨ˆ',
                'ä½œæ¥­Unitæ•°': '',
                'ä½œæ¥­è²»åˆè¨ˆ': filteredData.reduce((sum, d) => sum + d.workFee, 0),
                'ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ': filteredData.reduce((sum, d) => sum + d.management, 0),
                'äººæ•°': '',
                'å‹¤å‹™ç¨®åˆ¥': '',
                'çµŒè²»': filteredData.reduce((sum, d) => sum + d.expense, 0),
                'åæ”¯': filteredData.reduce((sum, d) => sum + d.profit, 0),
                'åŒæœŸçŠ¶æ…‹': ''
            };
            exportData.push(totals);

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ãµã˜ã¿é‡æ—¥å ±');

            const filename = monthFilter ? 
                `ãµã˜ã¿é‡æ—¥å ±_${monthFilter}.xlsx` : 
                `ãµã˜ã¿é‡æ—¥å ±_å…¨æœŸé–“.xlsx`;

            XLSX.writeFile(wb, filename);
        }
    </script>
</body>
</html>
